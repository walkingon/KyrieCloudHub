# 技术架构

## 1. 编程语言和框架

| 技术 | 版本/说明 |
|------|----------|
| **Dart** | SDK ^3.10.1 |
| **Flutter** | 跨平台UI框架 |
| **目标平台** | Windows、Android、Linux、iOS、macOS、Web |

## 2. 项目目录结构

```
kyrie_cloud_hub/
├── lib/                          # 核心代码
│   ├── main.dart                # 应用入口
│   ├── models/                  # 数据模型层
│   │   ├── platform_type.dart
│   │   ├── platform_credential.dart
│   │   ├── bucket.dart
│   │   ├── object_file.dart
│   │   └── transfer_task.dart
│   ├── screens/                 # UI页面层
│   │   ├── main_screen.dart
│   │   ├── bucket_objects_screen.dart    # 对象浏览器（已优化）
│   │   ├── platform_selection_screen.dart
│   │   ├── login_dialog.dart
│   │   ├── transfer_queue_screen.dart
│   │   ├── settings_screen.dart
│   │   └── about_screen.dart
│   ├── services/                # 业务服务层
│   │   ├── api/                # 云平台API适配器
│   │   │   ├── cloud_platform_api.dart    # 接口抽象
│   │   │   ├── tencent_cos_api.dart       # 腾讯云COS实现（已优化）
│   │   │   ├── aliyun_oss_api.dart        # 阿里云OSS实现（已优化）
│   │   │   ├── tencent/                   # 腾讯云模块
│   │   │   │   └── tencent_signature_generator.dart  # 签名生成器
│   │   │   └── aliyun/                    # 阿里云模块
│   │   │       └── aliyun_signature_generator.dart   # 签名生成器
│   │   ├── cloud_platform_factory.dart   # 工厂模式创建API
│   │   ├── storage_service.dart
│   │   ├── transfer_queue_service.dart
│   │   └── multipart_upload/    # 分片上传模块
│   │       ├── multipart_upload_manager.dart
│   │       └── file_chunk_reader.dart
│   ├── widgets/                 # 公共组件
│   └── utils/                   # 工具类
│       ├── logger.dart
│       ├── file_type_helper.dart          # 文件类型辅助工具（新增）
│       └── progress_dialog.dart           # 通用进度对话框（新增）
├── android/                     # Android原生配置
├── ios/                         # iOS原生配置
├── windows/                     # Windows原生配置
├── linux/                       # Linux原生配置
├── macos/                       # macOS原生配置
├── web/                         # Web配置
├── pubspec.yaml                 # 依赖配置
└── 技术架构.md                   # 技术架构文档
```

## 3. 核心依赖和技术栈

| 依赖 | 用途 |
|-----|------|
| **dio ^5.4.0** | HTTP客户端，网络请求 |
| **provider ^6.1.1** | 状态管理 |
| **shared_preferences ^2.2.2** | 本地持久化存储 |
| **path_provider ^2.1.2** | 获取系统路径 |
| **file_picker ^8.0.0** | 文件选择器 |
| **crypto ^3.0.3** | 加密哈希 |
| **intl ^0.19.0** | 国际化/日期格式化 |
| **url_launcher ^6.2.5** | 打开外部链接 |
| **xml ^6.5.0** | XML解析 |
| **cupertino_icons ^1.0.8** | iOS风格图标 |

## 4. 架构模式

采用分层架构 + 工厂模式 + 策略模式：

```
┌─────────────────────────────────────────────────────────┐
│                    UI层 (Screens)                       │
│         main_screen, bucket_objects_screen, etc.        │
└─────────────────────┬───────────────────────────────────┘
                      │ Provider状态管理
                      ▼
┌─────────────────────────────────────────────────────────┐
│                   服务层 (Services)                     │
│  storage_service, transfer_queue_service                │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│                API适配器层 (Factory Pattern)            │
│         CloudPlatformFactory.createApi()                │
└─────────────────────┬───────────────────────────────────┘
          ┌───────────┴───────────┐
          ▼                       ▼
┌─────────────────┐    ┌─────────────────────┐
│ TencentCosApi   │    │ AliyunOssApi        │
│ (策略实现)       │    │ (策略实现)           │
│ ├─签名生成器     │    │ ├─签名生成器         │
│ └─错误解析      │    │ └─XML解析           │
└─────────────────┘    └─────────────────────┘
          ▲                       ▲
          └─────────┬─────────────┘
                    │ 实现 ICloudPlatformApi 接口
```

## 6. 代码优化统计

| 文件 | 优化前 | 优化后 | 减少 |
|-----|--------|--------|------|
| bucket_objects_screen.dart | 2311行 | 2140行 | -171行 |
| aliyun_oss_api.dart | 1534行 | 1366行 | -168行 |
| tencent_cos_api.dart | 1320行 | 1190行 | -130行 |

### 优化措施

1. **签名逻辑分离** - 阿里云和腾讯云的签名算法分别提取到独立生成器类
   - `AliyunSignatureGenerator` - 阿里云OSS V4签名
   - `TencentSignatureGenerator` - 腾讯云COS HMAC-SHA1签名

2. **文件类型辅助工具** - `FileTypeHelper` 类统一管理文件图标和颜色配置
   - 替换了原来各174行的 `_getObjectIcon()` 和 `_getObjectColor()` 方法
   - 提供可复用的文件类型判断方法

3. **通用进度对话框** - `ProgressDialog` 工具类封装常用进度对话框
   - 下载进度、上传进度、批量操作进度等

## 7. 核心功能模块

| 模块 | 功能 |
|-----|------|
| **账号管理** | SecretID/SecretKey登录凭证管理 |
| **存储桶管理** | 查询、浏览存储桶 |
| **对象存储** | 文件上传(支持分片)、下载、删除 |
| **传输队列** | 任务队列管理，进度追踪 |
| **本地存储** | 凭证持久化存储 |
