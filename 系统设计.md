# KyrieCloudHub系统设计文档

## 应用概述

KyrieCloudHub是一款使用Flutter技术开发的，跨平台（Windows、Android等）支持多种云服务厂商（腾讯云、阿里云等）对象存储服务的聚合网盘服务客户端，该应用旨在为用户提供一种拥有独立控制权限的私有云盘服务。

## 核心功能

*说明：因各家云服务厂商对同一种服务的产品命名不同，如腾讯云中的对象存储COS与阿里云中的OSS，我们后文均以腾讯云产品及概念为例。*

### 1.账号登录

登录平台账号获取安全凭证是一切云盘文件操作的前提，当前应用提供以访问密钥（SecretID + SecretKey）的方式进行平台登录。密钥需要用户在官方开发平台自行创建获取。

应用目前需要支持登录的平台有：腾讯云、阿里云

### 2.查看存储桶列表

存储桶是文件存储的容器和载体，用户登录平台账号后，自动查询并列出存储桶列表。（暂不提供存储桶的创建和删除功能，用户在平台自行创建管理存储桶）

### 3.存储桶内文件管理

- 查看存储桶内文件列表

- 文件的下载

- 文件的删除

- 文件的上传

## 用户界面交互流程设计

### 设计要点

1. 应用中任何一个云厂商平台都可满足核心功能实现，用户一旦习惯使用某一个厂商平台后，不会轻易切换，因此平台登录的切换入口是一个非常低频的操作，可以设计在较深层次的界面中。

2. 重要操作需要二次确认对话框，如文件的删除。

### 交互流程

#### 1.App启动后进入主界面

主界面左侧为抽屉栏，子菜单依次为“平台切换”、“传输队列”、“设置”、“关于”。顶部AppBar水平居中显示为当前使用的平台名称，如“腾讯云”、“阿里云”或空内容（未选择平台时）

- 当用户为新用户，即应用本地没有查询到用户上一次登录的平台记录时，顶部AppBar显示空标题，界面中心显示一个“去选择平台”按钮，点击后进入平台选择界面。

- 当应用本地有用户上一次登录记录时，顶部AppBar显示平台名称，主界面列出查询到的存储桶列表。

*说明：登录概念只是方便用户理解。因该应用的功能是基于云厂商平台提供的无状态的HTTP请求API，并不存在实际的登录协议，应用内部对登录动作的处理实际上只做登录信息的本地存储*

#### 2.左侧抽屉栏的功能

用户点击左侧抽屉栏，展开子菜单“平台切换”、“传输队列”、“设置”、“关于”。

- 选择“平台切换”，进入平台选择界面

    - 平台选择界面列出可供选择的平台选项：“腾讯云”、“阿里云”。选项需显示登录状态（即是否有上一次登录成功的记录）。如对于有上一次登录成功记录的选项，选项中显示一个绿色对号的状态图标。对于有绿色对号状态的选项，选项后额外提供一个“登出”的按钮，点击该登出按钮后清理登录记录并刷新选项显示状态。
    - 当用户点击选择的平台选项为未登录状态（即用户从未使用该平台选项登录成功过），则弹出登录对话框。

        - 登录对话框显示需要输入的登录信息有：SecretID、SecretKey。用户输入全部信息后可点击“登录”按钮进行登录，或关闭该对话框以取消登录。
        - 用户点击登录后，应用返回主界面，刷新界面显示AppBar标题，并使用记录的登录信息查询存储桶列表，若查询成功则将该登录密钥记为登录成功，并刷新存储桶列表显示。
        - 若查询存储桶列表数据失败，给出界面提示错误原因，根据响应状态码判断若是密钥有误，则清理记录的登录密钥。

    - 当用户点击选择的平台选项有上一次登录成功记录，则直接使用上一次登录密钥进行登录，并返回主界面刷新相关内容显示。

- 选择“传输队列”，进入传输队列界面

    - 传输队列界面传输任务相关信息，分为“进行中”和“已完成”两个标签页。
    - “进行中”标签页
        - 显示当前上传或下载的对象文件列表，列表中元素需显示文件名、上传中/下载中、进度条、暂停按钮、取消按钮
        - 点击列表中的“暂停”或“取消”可对某个传输任务进行暂停或取消
    - “已完成”标签页
        - 显示已传输完成的文件名列表

- 选择“设置”，进入设置界面

    - 暂时无需内容显示

- 选择“关于”，进入关于界面

    - 显示内容
        - 应用图标（暂时用临时图片占位）
        - Copyright [2025] [walkingon]
        - GitHub链接地址（点击后可使用外部浏览器打开）：https://github.com/walkingon/KyrieCloudHub

#### 3.主界面列表视图

主界面列表视图是主界面内的主体内容，其以资源文件浏览器的形式显示存储桶列表或资源列表，支持“列表”和“网格”两种视图模式切换。

- 列表视图上方显示为当前文件路径，路径左侧为返回上一级按钮，路径右侧为视图切换滑动块。
- 列表右下方显示页码信息以及前后翻页的按钮。
- 当列表内容显示为存储桶列表时

    - 路径显示为根路径“/”
    - 点击存储桶列表可进入存储桶内对象文件列表。

- 当列表内容显示为对象文件列表时

    - 路径显示为当前“目录”路径
    - 目录路劲后显示加号按钮

        - 点击该加号按钮启动文件上传功能

            - 弹出操作系统的文件选择器，支持用户选择多个文件批量上传
            - 文件上传路径为存储桶的当前路径

    - 对象文件显示形式为图标、文件名（含扩展名）、创建时间
    - 点击对象图标或名称，显示该对象文件的可操作选项
        
        - 下载：进行该文件的下载
        - 删除：删除该对象文件


## 架构设计要点

- 需要支持大文件的传输，因此对与大文件进行分块读写，避免OOM风险。
- 需要支持文件的断点续传。
- 需要支持传输任务的暂停与取消。
- 后续需要扩展支持支持更多云厂商平台的REST API，因此需要封装一层通用且灵活的API的抽象层，便于后续扩展实现更多平台。


## 开发路线

### 阶段一：基础框架搭建 ✅ **已完成**

**目标：** 搭建应用基础架构，实现核心数据模型和状态管理

**任务清单：**
1. ✅ 项目结构规划
   - ✅ 创建标准的Flutter项目目录结构（lib/models、lib/services、lib/widgets、lib/screens、lib/utils）
   - ✅ 配置开发环境和依赖包（dio、shared_preferences、provider等）

2. ✅ 数据模型设计
   - ✅ 定义平台类型枚举（PlatformType）
   - ✅ 定义平台凭证模型（PlatformCredential）
   - ✅ 定义存储桶模型（Bucket）
   - ✅ 定义对象文件模型（ObjectFile、ObjectType）
   - ✅ 定义传输任务模型（TransferTask、TransferType、TransferStatus）

3. ✅ 本地存储服务
   - ✅ 实现登录凭证的本地持久化（SecretID、SecretKey）
   - ✅ 实现平台选择记录的本地存储
   - ✅ 实现断点续传信息的本地缓存

4. ✅ 抽象API层设计
   - ✅ 定义云平台API抽象接口（ICloudPlatformApi）
   - ✅ 设计统一的请求/响应模型（ApiResponse、ListObjectsResult）
   - ✅ 实现HTTP请求基础封装（HttpClient）
   - ✅ 实现云平台工厂类（CloudPlatformFactory）

**已实现文件清单：**
- `lib/models/platform_type.dart` - 平台类型枚举及扩展方法
- `lib/models/platform_credential.dart` - 平台凭证模型
- `lib/models/bucket.dart` - 存储桶模型
- `lib/models/object_file.dart` - 对象文件模型
- `lib/models/transfer_task.dart` - 传输任务模型
- `lib/services/storage_service.dart` - 本地存储服务
- `lib/services/api/cloud_platform_api.dart` - 云平台API抽象接口
- `lib/services/api/http_client.dart` - HTTP客户端封装
- `lib/services/cloud_platform_factory.dart` - 云平台API工厂类


### 阶段二：腾讯云COS集成 ✅ **已完成**

**目标：** 实现腾讯云平台完整功能链路

**任务清单：**
1. ✅ 腾讯云API实现
   - ✅ 实现腾讯云签名算法
   - ✅ 实现存储桶列表查询API
   - ✅ 实现对象列表查询API
   - ✅ 实现对象下载API（简单下载已实现，分块下载待实现）
   - ✅ 实现对象上传API（简单上传已实现，分块上传待实现）
   - ✅ 实现对象删除API

2. ✅ 基础UI实现
   - ✅ 实现主界面框架（Scaffold + Drawer）
   - ✅ 实现平台选择界面
   - ✅ 实现登录对话框
   - ✅ 实现存储桶列表视图（列表模式）
   - ✅ 实现对象文件列表视图（列表模式）

3. ✅ 核心功能实现
   - ✅ 实现平台切换逻辑
   - ✅ 实现存储桶查询与显示
   - ✅ 实现对象文件查询与显示
   - ✅ 实现文件删除（含二次确认）
   - ✅ 实现文件下载（用户选择保存位置 + 进度显示）

**已实现文件清单：**
- `lib/services/api/tencent_cos_api.dart` - 腾讯云COS API实现类
- `lib/services/api/http_client.dart` - HTTP客户端封装（添加ResponseType支持）
- `lib/screens/main_screen.dart` - 主界面框架（Scaffold + Drawer）
- `lib/screens/platform_selection_screen.dart` - 平台选择界面
- `lib/screens/login_dialog.dart` - 登录对话框
- `lib/screens/bucket_objects_screen.dart` - 存储桶对象文件列表视图（含文件上传、删除、下载功能）
- `lib/screens/transfer_queue_screen.dart` - 传输队列界面
- `lib/screens/settings_screen.dart` - 设置界面
- `lib/screens/about_screen.dart` - 关于界面


### 阶段二点五：日志系统 ✅ **已完成**

**目标：** 实现跨平台日志系统，支持本地文件持久化

**任务清单：**
1. ✅ 日志服务核心实现
   - ✅ 实现同步文件写入（确保日志不丢失）
   - ✅ 实现日志分类（UI操作、网络请求、错误、INFO）
   - ✅ 实现日志级别（DEBUG、INFO、WARNING、ERROR）
   - ✅ 实现日志时间戳格式
   - ✅ 实现日志文件轮转（1MB自动轮转，最多5个文件）

2. ✅ 日志集成
   - ✅ 集成全局异常捕获（FlutterError + PlatformDispatcher）
   - ✅ 集成网络请求日志（HttpClient拦截）
   - ✅ 集成用户操作日志（主要界面UI事件）

3. ✅ 日志特性
   - ✅ 仅Debug模式启用
   - ✅ 跨平台支持（Windows/Android等）
   - ✅ 控制台与文件双输出

**已实现文件清单：**
- `lib/utils/logger.dart` - 日志服务核心实现
- `lib/main.dart` - 全局异常捕获集成
- `lib/services/api/http_client.dart` - 网络日志集成
- `lib/screens/main_screen.dart` - 主界面UI日志
- `lib/screens/bucket_objects_screen.dart` - 文件操作UI日志
- `lib/screens/platform_selection_screen.dart` - 平台选择UI日志
- `lib/screens/login_dialog.dart` - 登录UI日志

**日志文件位置：**
- Windows: `%APPDATA%/../Documents/kyrie_cloud_hub.log`
- Android: 应用内部存储Documents目录


### 阶段三：传输功能增强（2-3周） ✅ **进行中**

**目标：** 实现大文件传输、断点续传、传输队列管理

**任务清单：**
1. ✅ 分块上传实现
   - ✅ 实现文件分块读取逻辑（FileChunkReader，支持流式分块读取，避免OOM）
   - ✅ 实现分块上传管理器（MultipartUploadManager，支持Initiate/UploadPart/Complete/Abort）
   - ✅ 实现分块上传签名回调（支持带额外头部的签名验证）
   - ✅ 实现传输进度计算
   - ✅ 默认分块大小：64MB

   **已实现文件清单：**
   - `lib/services/multipart_upload/file_chunk_reader.dart` - 文件分块读取器
   - `lib/services/multipart_upload/multipart_upload_manager.dart` - 分块上传管理器
   - `lib/services/api/cloud_platform_api.dart` - API接口添加 uploadObjectMultipart 方法
   - `lib/services/api/tencent_cos_api.dart` - 腾讯云分块上传实现

2. 断点续传实现
   - 实现传输任务状态持久化
   - 实现上传断点记录与恢复
   - 实现下载断点记录与恢复

3. 传输队列管理
   - 实现传输任务队列服务
   - 实现任务并发控制
   - 实现任务暂停/恢复/取消逻辑
   - 实现传输队列UI界面（进行中/已完成）

4. 批量操作支持
   - 实现多文件选择上传
   - 实现批量下载
   - 实现批量删除

### 阶段四：阿里云OSS集成（1-2周）

**目标：** 扩展支持阿里云平台

**任务清单：**
1. 阿里云API实现
   - 实现阿里云签名算法
   - 适配所有核心API到抽象接口（存储桶列表、对象操作等）

2. 平台适配
   - 验证平台切换流程
   - 调整UI显示适配不同平台特性
   - 测试多平台凭证管理

### 阶段五：UI完善与优化（1-2周）

**目标：** 完善用户界面，提升用户体验

**任务清单：**
1. 视图模式完善
   - 实现网格视图模式
   - 实现列表/网格视图切换
   - 实现文件图标差异化显示（根据文件类型）

2. 交互优化
   - 实现分页控制器
   - 实现路径导航优化
   - 实现加载状态提示
   - 实现错误提示优化

3. 其他界面
   - 实现设置界面框架
   - 实现关于界面
   - 实现传输队列详细信息展示

4. 响应式设计
   - 适配不同屏幕尺寸（手机、平板、桌面）
   - 优化横竖屏切换

### 阶段六：测试与优化（1-2周）

**目标：** 全面测试，性能优化，修复问题

**任务清单：**
1. 功能测试
   - 完整测试所有功能流程
   - 测试异常场景处理（网络断开、权限不足等）
   - 测试大文件传输稳定性
   - 测试多平台切换稳定性

2. 性能优化
   - 优化列表滚动性能
   - 优化内存占用（大文件处理）
   - 优化网络请求效率

3. 跨平台测试
   - Windows平台完整测试
   - Android平台完整测试
   - 修复平台特定问题

4. 代码优化
   - 代码重构与整理
   - 添加必要注释
   - 统一代码风格

### 阶段七：发布准备（1周）

**目标：** 准备应用发布

**任务清单：**
1. 应用配置
   - 配置应用图标
   - 配置应用名称和版本信息
   - 配置权限声明（文件访问、网络访问）

2. 文档编写
   - 编写用户使用文档
   - 编写密钥获取指引
   - 更新GitHub项目说明

3. 打包发布
   - 生成Windows安装包
   - 生成Android APK/AAB
   - 准备发布说明

### 预估总开发周期：10-15周

**备注：**
- 各阶段可根据实际开发进度灵活调整
- 建议采用敏捷开发模式，每周进行功能迭代和测试
- 优先保证核心功能稳定性，再进行功能扩展